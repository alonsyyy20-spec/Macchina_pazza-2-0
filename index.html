<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width,
               height=device-height,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no">

<title>Macchina Pazza 2.0</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #666;
    touch-action: none;
    font-family: Arial, sans-serif;
  }

  canvas {
    display: block;
    background: #aaa;
  }

  .controls {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 120px;
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: #666;
  }

  .controls button {
    width: 110px;
    height: 110px;
    font-size: 42px;
    border-radius: 25px;
    border: none;
    background: #ccc;
    touch-action: none;
  }
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="controls">
  <button id="leftBtn">‚¨ÖÔ∏è</button>
  <button id="rightBtn">‚û°Ô∏è</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// dimensioni canvas (sopra i controlli)
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 120;
}
window.addEventListener("resize", resize);
resize();

// STRADA
const lanes = 3;
let laneWidth = canvas.width / lanes;

// MACCHINA
let player = {
  lane: 1,
  size: 40,
  y: canvas.height - 60
};

let obstacles = [];
let speed = 4;
let startTime = Date.now();

// üîí BLOCCO ANTI DOPPIO TAP
let canMove = true;
function safeMove(direction) {
  if (!canMove) return;
  canMove = false;

  player.lane += direction;

  // clamp corsia (IMPOSSIBILE USCIRE)
  if (player.lane < 0) player.lane = 0;
  if (player.lane > lanes - 1) player.lane = lanes - 1;

  setTimeout(() => canMove = true, 120);
}

// CONTROLLI SICURI (pointerdown)
document.getElementById("leftBtn")
  .addEventListener("pointerdown", e => {
    e.preventDefault();
    safeMove(-1);
  });

document.getElementById("rightBtn")
  .addEventListener("pointerdown", e => {
    e.preventDefault();
    safeMove(1);
  });

// OSTACOLI
function addObstacle() {
  obstacles.push({
    lane: Math.floor(Math.random() * lanes),
    y: -50,
    size: 40
  });
}

// LOOP
function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  laneWidth = canvas.width / lanes;
  player.y = canvas.height - 60;

  // strada
  ctx.fillStyle = "#aaa";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // corsie
  ctx.strokeStyle = "#555";
  ctx.lineWidth = 2;
  for (let i = 1; i < lanes; i++) {
    ctx.beginPath();
    ctx.moveTo(i * laneWidth, 0);
    ctx.lineTo(i * laneWidth, canvas.height);
    ctx.stroke();
  }

  // punteggio
  const score = Math.floor((Date.now() - startTime) / 1000);
  ctx.fillStyle = "black";
  ctx.font = "22px Arial";
  ctx.fillText("Punteggio: " + score, 10, 30);

  // macchina
  const px = player.lane * laneWidth + laneWidth / 2 - player.size / 2;
  ctx.fillStyle = "red";
  ctx.fillRect(px, player.y, player.size, player.size);

  // ostacoli
  ctx.fillStyle = "black";
  for (let o of obstacles) {
    o.y += speed;
    const ox = o.lane * laneWidth + laneWidth / 2 - o.size / 2;
    ctx.fillRect(ox, o.y, o.size, o.size);

    if (
      o.lane === player.lane &&
      o.y + o.size > player.y &&
      o.y < player.y + player.size
    ) {
      alert("Game Over!\nPunteggio: " + score);
      location.reload();
    }
  }

  obstacles = obstacles.filter(o => o.y < canvas.height);
  requestAnimationFrame(update);
}

setInterval(addObstacle, 900);
update();
</script>

</body>
</html>
